---
title: "Beta Disper"
author: "MD"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
 html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---


```{r, include=FALSE}
library(tidyverse)
library(RColorBrewer)
library(car)
library(emmeans)
library(agricolae)
library(vegan)
```

# Read in Data

```{r, echo=FALSE}
P.rel <- readRDS('data/P.rel.RDS')

```

```{r run model}
d <- data.frame(sample_data(P.rel))
data <- data.frame(t(otu_table(P.rel)))
data <- decostand(data, method='hellinger') 
dist <- vegdist(data, method='bray')


```

# Beta dispersion

## Model

```{r}
mod <- betadisper(dist, interaction(d$Week, d$Fert), type = c("centroid"),bias.adjust = F)
mod
par(mfrow=c(1,1))
plot(mod)
anova(mod)
```

## Basic plots

```{r}
plot(mod, ellipse = TRUE, hull = FALSE, conf = 0.90) # 90% data ellipse
(mod.HSD <- TukeyHSD(mod))
plot(mod.HSD)
boxplot(mod,
        xlab="Week")
print(mod, digits = max(3, getOption("digits") - 3),
                           neigen = 8)
x <- rep(c(1,2,3,4,5,6,7,8),each=20)
df <- as.data.frame(mod$distances)
df$name <- rownames(df)
write.csv(df,'data/betadisper.csv')
```

## Model

```{r}
df<- read.csv('data/betadisper.csv')
df$week <- as.factor(df$week)
mod <- lm(data=df, log(int.dist) ~ Fert*week)
par(mfrow=c(2,2))
plot(mod)
aov.mod<- aov(mod)
summary(aov.mod)
t<-HSD.test(mod, "week");t
res <- emmeans(mod, list(pairwise ~ week*Fert), adjust = "fdr")
res
plot(res[[1]], horizontal=F)
groups <- data.frame(multcomp::cld(res[[1]], adjust='fdr', Letters=c("abcdefghijklmnopqrstuvwxy"), decreasing=F))
groups <- groups %>%
  arrange(week, Fert)
```

## Boxplot

```{r warning=F}
p <- ggplot() +
  geom_boxplot(data=df, aes(x=week, y=log(int.dist),fill=Fert)) +
  labs(y="Log-Transformed Distance to the Centroid", x="Week")+
  theme_classic()+
  scale_fill_manual(values = c('#1F78B4', '#33A02C', '#E31A1C', '#FF7F00'),
                    labels=c('Control', 'ESN', 'High Urea', 'Low Urea')) +
  theme(axis.text.x=element_text(colour = "black"), 
        axis.text.y=element_text(colour = "black"),
        axis.title=element_text(face="bold"),
        legend.title = element_blank(),
        axis.line = element_line(colour = "black"))+

  geom_text(data=groups,stat='identity',
            aes(x=week, y=emmean+SE, label=.group), 
            size=4,position=position_dodge(.9));p
ggsave(plot=p, filename = 'output/betadisper.png',width = 10,height = 6);p

```

