---
title: "Weekly Differential Abundance"
author: "MD"
date: "'r format(Sys.time(), '%b %d, %Y')'"
output: 
 html_document:
   toc: true
   toc_float: true
 editor_options:
   chunck_output_type: console
   chunk_output_type: console
---

```{r}
library(microbiomeMarker)
library(tidyverse)
library(readr)
library(egg)
```


```{r, differential abundance prep}
P.count <- readRDS('data/P.count.RDS')


P.c <- subset_samples(P.count, Fert=='Control')
P.u <- subset_samples(P.count, Fert=='Urea')
P.hu <- subset_samples(P.count, Fert=='HUrea')
P.e <- subset_samples(P.count, Fert=='ESN')


colnames(tax_table(P.c)) <- c('Kingdom', 'Phylum', 'Class', 'Order', 'Family', 'Genus', 'Species')
colnames(tax_table(P.u)) <- c('Kingdom', 'Phylum', 'Class', 'Order', 'Family', 'Genus', 'Species')
colnames(tax_table(P.hu)) <- c('Kingdom', 'Phylum', 'Class', 'Order', 'Family', 'Genus', 'Species')
colnames(tax_table(P.e)) <- c('Kingdom', 'Phylum', 'Class', 'Order', 'Family', 'Genus', 'Species')
```


# Calculate the weekly changes 

## Control
```{r, diff abund Control}
#weeks 1v2
out.glom <- microbiomeMarker::run_deseq2(
  P.c, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('1','2'))
out <-data.frame(microbiomeMarker::marker_table(out.glom)) %>% 
  mutate(Week='1v2') %>% 
  mutate(Fert='Control')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_CK_1v2.csv', row.names = FALSE)

#weeks 2v3
out.glom <- microbiomeMarker::run_deseq2(
  P.c, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('2','3'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='2v3') %>% 
  mutate(Fert='Control')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_CK_2v3.csv', row.names = FALSE)

#weeks 3v4
out.glom <- microbiomeMarker::run_deseq2(
  P.c, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('3','4'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='3v4') %>% 
  mutate(Fert='Control')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_CK_3v4.csv', row.names = FALSE)

#weeks 4v5
out.glom <- microbiomeMarker::run_deseq2(
  P.c, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('4','5'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='4v5') %>% 
  mutate(Fert='Control')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_CK_4v5.csv', row.names = FALSE)

#weeks 5v6
out.glom <- microbiomeMarker::run_deseq2(
  P.c, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('5','6'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='5v6') %>% 
  mutate(Fert='Control')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_CK_5v6.csv', row.names = FALSE)

#weeks 6v7
out.glom <- microbiomeMarker::run_deseq2(
  P.c, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('6','7'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='6v7') %>% 
  mutate(Fert='Control')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_CK_6v7.csv', row.names = FALSE)

#weeks 7v8
out.glom <- microbiomeMarker::run_deseq2(
  P.c, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('7','8'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='7v8') %>% 
  mutate(Fert='Control')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_CK_7v8.csv', row.names = FALSE)
```

## Low Urea
```{r, diff abund low Urea}
#weeks 1v2
out.glom <- microbiomeMarker::run_deseq2(
  P.u, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('1','2'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='1v2') %>% 
  mutate(Fert='Low_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_LU_1v2.csv', row.names = FALSE)

#weeks 2v3
out.glom <- microbiomeMarker::run_deseq2(
  P.u, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('2','3'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='2v3') %>% 
  mutate(Fert='Low_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_LU_2v3.csv', row.names = FALSE)

#weeks 3v4
out.glom <- microbiomeMarker::run_deseq2(
  P.u, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('3','4'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='3v4') %>% 
  mutate(Fert='Low_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_LU_3v4.csv', row.names = FALSE)

#weeks 4v5
out.glom <- microbiomeMarker::run_deseq2(
  P.u, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('4','5'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='4v5') %>% 
  mutate(Fert='Low_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_LU_4v5.csv', row.names = FALSE)

#weeks 5v6
out.glom <- microbiomeMarker::run_deseq2(
  P.u, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('5','6'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='5v6') %>% 
  mutate(Fert='Low_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_LU_5v6.csv', row.names = FALSE)

#weeks 6v7
out.glom <- microbiomeMarker::run_deseq2(
  P.u, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('6','7'))
out<-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='6v7') %>% 
  mutate(Fert='Low_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_LU_6v7.csv', row.names = FALSE)

#weeks 7v8
out.glom <- microbiomeMarker::run_deseq2(
  P.u, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('7','8'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='7v8') %>% 
  mutate(Fert='Low_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_LU_7v8.csv', row.names = FALSE)
```


## High Urea
```{r, diff abund H Urea}
#weeks 1v2
out.glom <- microbiomeMarker::run_deseq2(
  P.hu, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('1','2'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='1v2') %>% 
  mutate(Fert='High_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_HU_1v2.csv', row.names = FALSE)

#weeks 2v3
out.glom <- microbiomeMarker::run_deseq2(
  P.hu, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('2','3'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='2v3') %>% 
  mutate(Fert='High_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_HU_2v3.csv', row.names = FALSE)

#weeks 3v4
out.glom <- microbiomeMarker::run_deseq2(
  P.hu, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('3','4'))
out<-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='3v4') %>% 
  mutate(Fert='High_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_HU_3v4.csv', row.names = FALSE)

#weeks 4v5
out.glom <- microbiomeMarker::run_deseq2(
  P.hu, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('4','5'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='4v5') %>% 
  mutate(Fert='High_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_HU_4v5.csv', row.names = FALSE)

#weeks 5v6
out.glom <- microbiomeMarker::run_deseq2(
  P.hu, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('5','6'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='5v6') %>% 
  mutate(Fert='High_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_HU_5v6.csv', row.names = FALSE)

#weeks 6v7
out.glom <- microbiomeMarker::run_deseq2(
  P.hu, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('6','7'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='6v7') %>% 
  mutate(Fert='High_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_HU_6v7.csv', row.names = FALSE)

#weeks 7v8
out.glom <- microbiomeMarker::run_deseq2(
  P.hu, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('7','8'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='7v8') %>% 
  mutate(Fert='High_Urea')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_HU_7v8.csv', row.names = FALSE)
```

## ESN
```{r, diff abund ESN}
#weeks 1v2
out.glom <- microbiomeMarker::run_deseq2(
  P.e, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('1','2'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='1v2') %>% 
  mutate(Fert='ESN')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_ESN_1v2.csv', row.names = FALSE)

#weeks 2v3
out.glom <- microbiomeMarker::run_deseq2(
  P.e, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('2','3'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='2v3') %>% 
  mutate(Fert='ESN')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_ESN_2v3.csv', row.names = FALSE)

#3weeks 3v4
out.glom <- microbiomeMarker::run_deseq2(
  P.e, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('3','4'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='3v4') %>% 
  mutate(Fert='ESN')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_ESN_3v4.csv', row.names = FALSE)

#weeks 4v5
out.glom <- microbiomeMarker::run_deseq2(
  P.e, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('4','5'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='4v5') %>% 
  mutate(Fert='ESN')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_ESN_4v5.csv', row.names = FALSE)

#weeks 5v6
out.glom <- microbiomeMarker::run_deseq2(
  P.e, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('5','6'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='5v6') %>% 
  mutate(Fert='ESN')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_ESN_5v6.csv', row.names = FALSE)

#weeks 6v7
out.glom <- microbiomeMarker::run_deseq2(
  P.e, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('6','7'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='6v7') %>% 
  mutate(Fert='ESN')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_ESN_6v7.csv', row.names = FALSE)

#weeks 7v8
out.glom <- microbiomeMarker::run_deseq2(
  P.e, group="Week",taxa_rank="Species",norm="RLE",transform="identity",
  p_adjust='fdr', pvalue_cutoff=0.05,
  contrast=c('7','8'))
out <-data.frame(microbiomeMarker::marker_table(out.glom))%>% 
  mutate(Week='7v8') %>% 
  mutate(Fert='ESN')
out$enrich_group <- gsub('X','',out$enrich_group)
write.csv(out, 'data/DA.files/DA_ESN_7v8.csv', row.names = FALSE)
```

## Combine above into one df

```{r}
d <- list.files(path="data/DA.files", full.names = TRUE) %>% 
  lapply(read_csv) %>% 
  bind_rows 
df <- read.csv('data/DiffAbund_Weekly.csv')
d$enrich_group = as.factor(d$enrich_group)

```


```{r,  fig 1}
x = tapply(d$ef_logFC, d$feature, function(x) max(x))
x = sort(-x, TRUE)


p<-ggplot() + 
  geom_point(d, alpha=0.4,mapping=aes(
    x=Week, y=ef_logFC,   fill=enrich_group),size=5,color='black',pch=21) + 
  geom_hline(yintercept = 0)+
  facet_wrap(~Fert, ncol=4, scales='free')+
  scale_fill_brewer(palette = 'Set1')+
  labs(y='Log Fold Change')+
  theme(axis.text.x = element_text(vjust = 0.5),
        axis.text=element_text(size=10, colour = "black"), 
        axis.title=element_text(size=15,face="bold"),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.key = element_blank(),
        legend.text = element_text(size = 14),
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        strip.background = element_blank());p 
p<- tag_facet(p, size = 5);p #A=CK, B=ESN, C=HU, D=LU
ggsave(plot=p, filename = 'figures/DiffAbundByWeek.png',width = 10,height = 8)
```

